name: 🚀 CI/CD to AWS EC2 with Docker

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 🧾 Checkout código
        uses: actions/checkout@v3

      - name: 🔧 Configurar clave SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.-----BEGIN OPENSSH PRIVATE KEY----- b3BlbnNzaC1rZXktdjEAAAAACmFlczI1Ni1jdHIAAAAGYmNyeXB0AAAAGAAAABDFXLcGsg hho/PACe+7gvjIAAAAEAAAAAEAAAIXAAAAB3NzaC1yc2EAAAADAQABAAACAQDASCnbk0QG hNGm5iS1KoM4X54DQDkT56ZhtVkmgdW7Nrr7NvNWEGTg77PSESqLo8fISK13H5N2OL37zO v2GNwmzXTpK5kHt72F8Bjdvs3BO/yzuekY3RlA/eu8ybX4BXTy8fSocMz25LxYAkzTsQy5 2yU3ba06kbZN1xpjR+9PRFEQiXTwYz0HQtEyKBkEknEprmO+Bq+yaNAt7cLkA21jjAZlL8 +VXh0MJFdlvvfT++YyI6KehO+Yvhyn5y1Gzka3mD4LotxohcsazJKGLzWwed9TERax2V2v a16ZEEUvwvNme9OUw1WWZdu7KrQoB0inyWnXpaxkKf1Z3JDNPlVexTMuHvJM8x1q1AKKDf gsa4LVUy4bthDfhSRZOfV4TppVkdto7chDutRWYK7L190D0N0Eup0YiUzdUhBg1we6pTRX bXXS0moXTHA+/dN6SSAWkXQNGrRWIpPoIMnhLaAOsmrqqFUI1Ak6uIkJwYcvLPKZz3Nc2P rR0cK6GAOLq3EzIzAFTQ6ZoPqoJhqj7y8ZIjz8w8OLHa84l+BWteC1EWcLVyY7xrOutiHy kg9/XWYjRbzGQaZ7FaeSx2nk2pIr4+RwdPvjtqTPnufH7FJ2HajbkHwgSQKjEfSOC4fdrk iSSzZWUP03Gzf7xsj71dn/hM5SugQ/9PcXAnqBdGXPBwAAB1AaTKHz3kgp7ZYLRpjo+hA9 P/8EoN9SqQ0+0a/AoqwrbDnWaYRqRmU5jr7z8KRYajeCLSTbf1Px8MJLHibeX2aLppODHx hoJRR7ed2PFR0DtlfnlpcOLi3c5XvbxJSsc8BSrXZmONn1k7My1HlUKKL2vnGwsqvV1isu swwgKGlUysfwgpxHpIE96geJte2Y0AYPSZneQMbZWnV8v/bya/yyOx2aulMaPJyvqyXIDf fxp4iBJT0p4rcAFORTmNw4/oGH/Uy/ZeWDrYDcwI9/8iYCfiFnPOosMul1TzWg69D9pRz1 U2vxnCI2E+qL3+hLDSBQIsSPmf4G3nJ9x6f7bmsV5xmJvhcLgDpqvbCgtuE/ZFO8JQl6BJ +4NeH7EpuBj0GqAIiMOkXrac7SbGgdT6zFrWEddwxN6ltPSeK3DQXzpTtDnp3XbajDTziR +sHjzljiz60dXZbOaoJXEtqDFRA9ZlCfKFPbIbekwWn9SNYQoRnmIJR75DyoOb76nGidaB cDToYrzigHjNLbDUkpBnZxWYZfHsyE3LU3uDhXhdR7CR+OPbaUgeiCFp9gUXctyfPDvB44 UIQkbCVjR16HUhRWhThmZvxrZ4lKZD8/QQW/+fqrsfVkIzoehOzSYAMnUaVNQiyxZfQz8o jtN6/JPRuxpbpT79s2NQK7cKPk7kyFY0J+NauR0s6dFjHrqnjoXVUohzS5kfE9yVCrVQ+rSYbi2huAvXfWXAoCz/jPJCsJLn757tS62V5lMaIVgCq87Hw9xQLqqClawwo/VR9Awn5P7F slo1XFbDA3Np8bT8b7w14lC1cgocaumcxr15R6Em4McmyrL3eMljQc2NbwZjANiZJoZ4Gs bJlHWoSLxC8iQBSPqB5dUcm0AL+SUoTDqPPKIwcUZmtad6S3IPtCjeO3JRU4udzjCskAUK T85tHNxryPkZ1cTego5GNd2ykmFdkKMmB5xxtuT1m+zs8dvcsCc5B/9ypFCYjr5IKPyj5y ysuS49G0qEUmEHSVi447nzorrrSPccUMvulSXmXOqgJCR/DXyKIcCTChB8qjFXMFVty+uc NrguPCO/ZBaOxCgUGuircFDC1A3RAxArDF7k7f3fugKkwMNswNM+TePhltrfjGpeaizpVT wrN+u6nu+tOarib+lk7xX/zvZTqEpHTzqSPorruQsI+9VbtuyugZAzhq/oZyC7kmAhhwzf QmA0FHHWbhYs6b7hB+GPZIFCxYFX5oKoeVby4zqxZv+AZSNSZxSl5thM8uCv81eWhdVqs2 xedbGmoJVTFz1n3gUiuXt3R1/cxJXYPPPYzldkFdEabVW5N3CKCIsOApfWHpJmuz0Lkgtz RY9Eb5IAtFs3N89lwQbTd2e9zwDigHAgd+2zJUCl4ifxtNoHkt8+dB6Q1dR3EFW1o1w4Kq UHRSaiXJNAF7suth0gJyicV4SKP2SaX2NaoV64vV1MVXj19Zqp0gm1WKpkmP8YoEZ/71T9 vHx9aB/chje/5PPmGh2vDoNl877ke/Q99shubYpi/XUimIF4supYLrsgDhAK8wj9iv6TfY QQakOydNCKRM9oZsVdNFjPebqOgd2HBx2udmJ5U8EuU8O+rsZhRXIKePmsXLzuecssDqe1 snGfMmSUiOU1iC/qWHMh7idYj9e/HlZCwXKBGUQ+LX7xi7Ks6qrWwcMJWGTNI62FRMshdg cljFIj3u9q1QlelgF0wgm3OXsqOqp7teDO66KnNPtc4jtBgRwN4b9F1yuLyE3AOEJagv9Z uEXPM9DYJav8lCaGPmm/XBcYKhFszd++Om5J03vbo4c+Q5aHzAA6mPIZvZjhmbzpMo0yeB 73DLJcbIeXcduN8WLaxRRVV1QPe8kMxoRwftdCxf6ASBVtqAn935Zb1CxAfnWgH1WgbAUJ pV65uf6hKQwjcVKWFLJ3bY8TXckmFYw4tzgF9WInBGDT7zdGV7ly9RQsGDw+Vx0tuHfH6F z9QHGKoIN6PG7eMxe/JclEWxDgRRgixMdYn0uEQs0y9uQDc7y9dBA0xFnflFkTF43uLG82 4y5aONMi4/DgUVi18O7Kt/9zqSSKJykpQUQWNJvSdwJj1fv9a9sZmil+JWm9Fj4h2eiggG XbheRexQTuGuCow7g+iUmE0dObEEfRvGcBDeO3HIqv1JDzSoEgwiRhwSpH9X7YyWfjax6w AWlf/2rCxbaYYeo7d+m/8VvZ//hvnIbs7wfuHDmzaDE2ci43lx7jBObTG73k7JPINZf8/F iFckDU+FnqolG6zxDp4RxESNO935P55UsO0J7jgtNoR3OdoXf+riPXKGyvXQ6WZp2eMPVZ LHC/7y08yjJD4aIhADb/QhVCQOEHFTQtBW03OTpYgHcOU+PCM6dC0TuB/zVF63G96qKOhn XurKl3R71PgWWrH1B5hgfAFzPJCUrMedQ+JEPrhje7NrPxX03jEWU94UM+tKPjmPDyGQ1e llWeIO2AgL3mtQcSPnzmJqdHU= -----END OPENSSH PRIVATE KEY-----  }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.54.202.242.17 }} >> ~/.ssh/known_hosts

      - name: 🐳 Subir proyecto y construir en EC2
        run: |
          ssh ${{ secrets.ubuntu }}@${{ secrets.54.202.242.17 }} << 'EOF'
            # Crear carpeta si no existe
            mkdir -p ~/movies-api
            cd ~/movies-api

            # Limpiar y clonar de nuevo
            rm -rf *
            git clone https://github.com/Danielr-1998/movie-rest.git . || true
            git pull

            # Build del proyecto
            ./mvnw clean package

            # Build imagen Docker
            docker stop movies-api || true
            docker rm movies-api || true
            docker build -t movies-api .

            # Ejecutar nuevo contenedor
            docker run -d --name movies-api -p 8080:8080 movies-api
          EOF
